---
phase: 02-pr-review-pipeline
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - entrypoints/ado-pr.content/components/ReviewButton.tsx
  - entrypoints/ado-pr.content/components/ReviewProgress.tsx
  - entrypoints/ado-pr.content/App.tsx
  - entrypoints/ado-pr.content/style.css
autonomous: false

must_haves:
  truths:
    - "User clicks review button and a port-based review session starts"
    - "User sees which file is being reviewed and how many remain (CORE-04)"
    - "User sees per-file completion status as each file finishes"
    - "User sees a final summary with finding counts and severity breakdown"
    - "User sees which files had errors if any file fails (CORE-05)"
    - "Button is disabled during an active review to prevent double-triggering"
    - "UI resets to idle state if the port disconnects unexpectedly"
  artifacts:
    - path: "entrypoints/ado-pr.content/components/ReviewButton.tsx"
      provides: "Port-based review trigger with state management"
      exports: ["default (ReviewButton)"]
    - path: "entrypoints/ado-pr.content/components/ReviewProgress.tsx"
      provides: "File-by-file progress indicator"
      exports: ["default (ReviewProgress)"]
    - path: "entrypoints/ado-pr.content/App.tsx"
      provides: "Root component with review state machine"
      exports: ["default (App)"]
    - path: "entrypoints/ado-pr.content/style.css"
      provides: "Styles for button states, progress, and results"
  key_links:
    - from: "entrypoints/ado-pr.content/components/ReviewButton.tsx"
      to: "browser.runtime.connect"
      via: "Opens port with name 'review' on click"
      pattern: "runtime\\.connect.*review"
    - from: "entrypoints/ado-pr.content/components/ReviewButton.tsx"
      to: "entrypoints/background.ts"
      via: "Port messages (START_REVIEW -> REVIEW_PROGRESS/COMPLETE/ERROR)"
      pattern: "START_REVIEW"
    - from: "entrypoints/ado-pr.content/App.tsx"
      to: "entrypoints/ado-pr.content/components/ReviewProgress.tsx"
      via: "Renders progress component during reviewing state"
      pattern: "ReviewProgress"
    - from: "entrypoints/ado-pr.content/App.tsx"
      to: "entrypoints/ado-pr.content/components/ReviewButton.tsx"
      via: "Renders button and receives state callbacks"
      pattern: "ReviewButton"
---

<objective>
Rewrite the content script UI to trigger port-based reviews, display real-time progress, and show results with error indication. This connects the user-facing button to the pipeline built in Plan 02-02.

Purpose: Makes the review pipeline visible and usable. Without this plan, the pipeline works but has no user interface. After this plan, all five Phase 2 success criteria are met.

Output: 4 files -- rewritten `ReviewButton.tsx`, new `ReviewProgress.tsx`, updated `App.tsx`, updated `style.css`
</objective>

<execution_context>
@/Users/81169560/.claude/get-shit-done/workflows/execute-plan.md
@/Users/81169560/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-pr-review-pipeline/02-RESEARCH.md
@.planning/phases/02-pr-review-pipeline/02-01-SUMMARY.md
@.planning/phases/02-pr-review-pipeline/02-02-SUMMARY.md

@entrypoints/ado-pr.content/App.tsx
@entrypoints/ado-pr.content/components/ReviewButton.tsx
@entrypoints/ado-pr.content/style.css
@entrypoints/ado-pr.content/index.tsx
@shared/types.ts
@shared/messages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite ReviewButton, create ReviewProgress, update App</name>
  <files>
    entrypoints/ado-pr.content/components/ReviewButton.tsx
    entrypoints/ado-pr.content/components/ReviewProgress.tsx
    entrypoints/ado-pr.content/App.tsx
  </files>
  <action>
**Rewrite `entrypoints/ado-pr.content/App.tsx`:**

App.tsx becomes the state machine controller for the review UI. It manages the overall review state and renders the appropriate component.

State model:
```typescript
type ReviewState =
  | { phase: 'idle' }
  | { phase: 'reviewing'; progress: ReviewProgress; fileResults: FileReviewResult[] }
  | { phase: 'complete'; summary: ReviewSummary; fileResults: FileReviewResult[] }
  | { phase: 'error'; message: string };
```

Props: `{ prInfo: PrInfo }` (same as before).

Implementation:
1. `const [reviewState, setReviewState] = useState<ReviewState>({ phase: 'idle' })`.
2. Render based on `reviewState.phase`:
   - `'idle'`: Render `<ReviewButton prInfo={prInfo} onReviewStart={handleStart} onProgress={handleProgress} onFileComplete={handleFileComplete} onComplete={handleComplete} onError={handleError} />`.
   - `'reviewing'`: Render `<ReviewButton prInfo={prInfo} disabled={true} />` above `<ReviewProgress progress={reviewState.progress} fileResults={reviewState.fileResults} />`.
   - `'complete'`: Render `<ReviewButton prInfo={prInfo} onReviewStart={handleStart} ... />` (re-enabled for new review) above a brief completion summary div. Show: "Review complete -- {totalFindings} findings across {reviewedFiles} files. Comments posted to PR."
   - `'error'`: Render `<ReviewButton prInfo={prInfo} onReviewStart={handleStart} ... />` (re-enabled for retry) above an error message div.

Callback handlers:
- `handleStart()`: `setReviewState({ phase: 'reviewing', progress: { currentFile: '', fileIndex: 0, totalFiles: 0, status: 'reviewing' }, fileResults: [] })`.
- `handleProgress(progress: ReviewProgress)`: Update progress in state while keeping fileResults.
- `handleFileComplete(result: FileReviewResult)`: Append result to fileResults array in state.
- `handleComplete(summary: ReviewSummary)`: `setReviewState({ phase: 'complete', summary, fileResults: prev.fileResults })`.
- `handleError(message: string)`: `setReviewState({ phase: 'error', message })`.

Import types from `@/shared/types` and `@/shared/messages`.

**Rewrite `entrypoints/ado-pr.content/components/ReviewButton.tsx`:**

Complete rewrite. The button now opens a `browser.runtime.connect` port and manages the review session lifecycle.

Props:
```typescript
interface ReviewButtonProps {
  prInfo: PrInfo;
  disabled?: boolean;
  onReviewStart?: () => void;
  onProgress?: (progress: ReviewProgress) => void;
  onFileComplete?: (result: FileReviewResult) => void;
  onComplete?: (summary: ReviewSummary) => void;
  onError?: (message: string) => void;
}
```

State: `const [active, setActive] = useState(false)` -- tracks whether a review port is open.

`handleClick` function:
1. If `disabled` or `active`, return early.
2. Set `active = true`.
3. Call `onReviewStart?.()`.
4. Open port: `const port = browser.runtime.connect({ name: 'review' })`.
5. Send start message: `port.postMessage({ type: 'START_REVIEW', payload: { prInfo } })`.
6. Add `port.onMessage.addListener` that handles:
   - `REVIEW_PROGRESS`: call `onProgress?.(msg.payload)`.
   - `REVIEW_FILE_COMPLETE`: call `onFileComplete?.(msg.payload)`.
   - `REVIEW_COMPLETE`: call `onComplete?.(msg.payload)`, then `port.disconnect()`, then `setActive(false)`.
   - `REVIEW_ERROR`: call `onError?.(msg.payload.message)`, then `port.disconnect()`, then `setActive(false)`.
7. Add `port.onDisconnect.addListener`: if `active` is still true (unexpected disconnect), call `onError?.('Connection to service worker lost')`, set `active = false`.

Use `useRef` to hold the port reference so the disconnect listener can check current state. Clean up on unmount: if port ref exists, disconnect it.

Render: A button with class `pep-review-btn`. When `active` or `disabled`, show "Reviewing..." text and apply `pep-review-btn--reviewing` class. Otherwise show "PEP Review" text. Always `disabled={active || disabled}`.

Do NOT import `sendMessage` -- this component uses port communication exclusively. Import `PrInfo`, `ReviewProgress`, `FileReviewResult`, `ReviewSummary` from `@/shared/types`. Import `PortMessage` from `@/shared/messages` for the port.onMessage handler typing.

**Create `entrypoints/ado-pr.content/components/ReviewProgress.tsx`:**

New component that shows file-by-file review progress.

Props:
```typescript
interface ReviewProgressProps {
  progress: ReviewProgress;
  fileResults: FileReviewResult[];
}
```

Render:
1. **Progress bar area:**
   - Text: "Reviewing file {fileIndex} of {totalFiles}" (or "Preparing review..." if fileIndex === 0).
   - If `progress.status === 'posting-comments'`, text: "Posting comments for {currentFile}..."
   - A visual progress bar: `<div class="pep-progress-bar"><div class="pep-progress-fill" style={{ width: `${(fileIndex / totalFiles) * 100}%` }} /></div>`.
   - Current file name: `<div class="pep-progress-file">{truncateFileName(currentFile)}</div>`.

2. **File results list** (scrollable, max-height 150px):
   - For each completed file result, show a row:
     - Success: green checkmark + filename + "{findingCount} findings"
     - Error: red X + filename + "Error" (with title tooltip showing the error message)
     - Skipped: grey dash + filename + "Skipped"

Helper: `truncateFileName(path: string): string` -- if path is longer than 40 chars, show `.../{last-two-segments}`.

Keep the component compact -- it renders inline in the Azure DevOps PR page. Use CSS classes from style.css (prefixed with `pep-`).
  </action>
  <verify>
Run `pnpm exec tsc --noEmit` -- must pass. Verify ReviewButton.tsx uses `browser.runtime.connect` (not `sendMessage`). Verify ReviewProgress.tsx exists and renders progress bar and file results. Verify App.tsx renders different content based on reviewState.phase.
  </verify>
  <done>
ReviewButton.tsx opens a review port on click and dispatches progress callbacks. ReviewProgress.tsx shows current file, progress bar, and completed file results with status indicators. App.tsx manages the review state machine (idle/reviewing/complete/error) and renders appropriate UI. Port lifecycle is handled with proper cleanup on disconnect/unmount.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update styles for review states and progress UI</name>
  <files>
    entrypoints/ado-pr.content/style.css
  </files>
  <action>
**Update `entrypoints/ado-pr.content/style.css`:**

Keep ALL existing styles. Add new styles AFTER the existing button state classes.

**Button reviewing state** (replaces the Phase 1 `--checking`, `--authenticated`, `--unauthenticated` states -- but keep those classes in case they're referenced elsewhere):

```css
.pep-review-btn--reviewing {
  background-color: #605e5c;
  cursor: wait;
}
```

**Review container** (wraps button + progress/results):
```css
.pep-review-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-width: 360px;
}
```

**Progress bar:**
```css
.pep-progress {
  padding: 8px 12px;
  background: #faf9f8;
  border: 1px solid #edebe9;
  border-radius: 4px;
  font-size: 12px;
  color: #323130;
}

.pep-progress-status {
  margin-bottom: 6px;
  font-weight: 600;
}

.pep-progress-bar {
  height: 4px;
  background: #edebe9;
  border-radius: 2px;
  overflow: hidden;
  margin-bottom: 4px;
}

.pep-progress-fill {
  height: 100%;
  background: #0078d4;
  border-radius: 2px;
  transition: width 0.3s ease;
}

.pep-progress-file {
  color: #605e5c;
  font-size: 11px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
```

**File results list:**
```css
.pep-file-results {
  max-height: 150px;
  overflow-y: auto;
  margin-top: 6px;
  border-top: 1px solid #edebe9;
  padding-top: 6px;
}

.pep-file-result {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 2px 0;
  font-size: 11px;
  color: #323130;
}

.pep-file-result-icon {
  flex-shrink: 0;
  width: 14px;
  text-align: center;
}

.pep-file-result-icon--success { color: #107c10; }
.pep-file-result-icon--error { color: #d13438; }
.pep-file-result-icon--skipped { color: #a19f9d; }

.pep-file-result-name {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.pep-file-result-count {
  flex-shrink: 0;
  color: #605e5c;
}
```

**Completion/error status:**
```css
.pep-review-complete {
  padding: 8px 12px;
  background: #dff6dd;
  border: 1px solid #107c10;
  border-radius: 4px;
  font-size: 12px;
  color: #107c10;
}

.pep-review-error {
  padding: 8px 12px;
  background: #fde7e9;
  border: 1px solid #d13438;
  border-radius: 4px;
  font-size: 12px;
  color: #d13438;
}
```

All colors use the Fluent UI / Azure DevOps design system palette (same grays, blues, greens, and reds used in the existing button styles). This ensures the review UI looks native in the Azure DevOps page.

IMPORTANT: Also update the App.tsx component to wrap its output in a `<div className="pep-review-container">` so the flex layout applies. If this was not done in Task 1, make this small adjustment now. The container div wraps the button and any progress/result content.
  </action>
  <verify>
Run `pnpm exec tsc --noEmit` -- must pass. Run `pnpm build` -- must succeed without errors (verifies CSS is valid and all imports resolve). Verify style.css contains all new classes: pep-review-container, pep-progress, pep-progress-bar, pep-progress-fill, pep-file-results, pep-review-complete, pep-review-error.
  </verify>
  <done>
style.css has all styles for the review UI: button reviewing state, progress bar with fill animation, file results list with success/error/skipped icons, completion banner, and error banner. Colors match Azure DevOps Fluent UI palette. The build succeeds with all styles and components.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete PR review pipeline: clicking "PEP Review" on an Azure DevOps PR fetches changed files, reviews each with OpenAI (gpt-4o), posts inline comments with severity tags (Critical/Warning/Info) on specific lines, posts a summary comment, shows real-time progress, and handles errors gracefully. Non-code files are skipped automatically.
  </what-built>
  <how-to-verify>
1. Run `pnpm dev` to start the extension in development mode
2. Open Chrome and load the unpacked extension from `.output/chrome-mv3-dev`
3. Navigate to the extension options page, enter a valid OpenAI API key, and save
4. Navigate to an Azure DevOps PR with 3-10 changed code files (and ideally some non-code files like lockfiles or images)
5. Verify the "PEP Review" button appears in the PR header
6. Click "PEP Review" and verify:
   - Button changes to "Reviewing..." and becomes disabled
   - Progress indicator appears showing "Reviewing file 1 of N"
   - Progress bar advances as each file completes
   - Each completed file shows a green checkmark with finding count
   - Non-code files (lockfiles, images) are NOT listed (skipped silently)
7. After completion, verify:
   - A green "Review complete" banner shows total findings
   - In the Azure DevOps PR, inline comments appear on specific code lines with **[Critical]**, **[Warning]**, or **[Info]** severity tags
   - A summary comment appears at the PR level with the PEP Review Summary table
   - The review button returns to clickable "PEP Review" state
8. (Optional) Test error resilience: if you can force one file to fail (e.g., very large file), verify remaining files still complete and the failed file shows a red X in the results list
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. `pnpm exec tsc --noEmit` passes with zero errors
2. `pnpm build` succeeds
3. ReviewButton.tsx uses `browser.runtime.connect({ name: 'review' })` to trigger reviews
4. ReviewProgress.tsx renders progress bar, current file, and file result list
5. App.tsx has 4 states: idle, reviewing, complete, error
6. style.css has all review UI classes
7. End-to-end: click button -> progress shown -> inline comments posted -> summary posted -> completion shown
</verification>

<success_criteria>
All five Phase 2 success criteria are met:
1. CORE-04: User clicks review button and sees progress showing which file is being reviewed and how many remain
2. ADO-04 + ADO-06: After review completes, inline comments appear on specific changed lines in the PR with severity tags (Critical/Warning/Info)
3. ADO-05 + LLM-08: A top-level summary comment appears on the PR with an overview across all reviewed files
4. LLM-06: Non-code files (lockfiles, binaries, images) are automatically skipped without user intervention
5. CORE-05: If one file fails to review, the remaining files still complete and the user sees which files had errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-pr-review-pipeline/02-03-SUMMARY.md`
</output>
