---
phase: 01-extension-shell-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - wxt.config.ts
  - package.json
  - tsconfig.json
  - shared/types.ts
  - shared/messages.ts
  - shared/storage.ts
  - shared/constants.ts
  - lib/url-matcher.ts
  - lib/selectors.ts
autonomous: true

must_haves:
  truths:
    - "WXT project builds successfully with `npm run build`"
    - "URL matcher correctly parses Azure DevOps PR URLs into org/project/repo/prId"
    - "URL matcher rejects non-PR URLs"
    - "Selector helper tries multiple CSS selectors in order and returns first match"
  artifacts:
    - path: "wxt.config.ts"
      provides: "WXT configuration with manifest overrides for Azure DevOps"
      contains: "host_permissions.*dev.azure.com"
    - path: "lib/url-matcher.ts"
      provides: "PR URL parsing and matching"
      exports: ["parsePrUrl", "isPullRequestUrl"]
    - path: "lib/selectors.ts"
      provides: "Centralized DOM selectors with fallback strategy"
      exports: ["SELECTORS", "querySelector", "checkSelectorHealth"]
    - path: "shared/types.ts"
      provides: "Shared type definitions including PrInfo"
      contains: "PrInfo"
    - path: "shared/messages.ts"
      provides: "Typed message definitions for content-script/service-worker communication"
      contains: "CHECK_AUTH"
    - path: "shared/storage.ts"
      provides: "Storage key definitions and typed helpers"
      contains: "chrome.storage"
    - path: "shared/constants.ts"
      provides: "URL patterns and API base URLs"
      contains: "dev.azure.com"
  key_links:
    - from: "lib/url-matcher.ts"
      to: "shared/types.ts"
      via: "imports PrInfo type"
      pattern: "import.*PrInfo.*from.*shared/types"
    - from: "shared/messages.ts"
      to: "shared/types.ts"
      via: "uses shared types in message payloads"
      pattern: "import.*from.*shared/types"
---

<objective>
Initialize the WXT Chrome extension project and create all shared infrastructure that Plans 02 and 03 depend on.

Purpose: Establish the project foundation so the content script (Plan 02) and auth system (Plan 03) can be built in parallel without file conflicts.
Output: A buildable WXT project with shared types, URL matcher, DOM selectors, message definitions, and storage helpers.
</objective>

<execution_context>
@/Users/81169560/.claude/get-shit-done/workflows/execute-plan.md
@/Users/81169560/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-extension-shell-auth/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize WXT project with React template and configure manifest</name>
  <files>
    wxt.config.ts
    package.json
    tsconfig.json
  </files>
  <action>
    Initialize a new WXT project in the current directory (which is the repo root). Use the WXT CLI:

    ```bash
    npx wxt@latest init . --template react
    ```

    If the init command complains about existing files (.git, .planning, .claude), initialize in a temp directory and move files:
    ```bash
    npx wxt@latest init /tmp/pep-review-init --template react
    # Then copy everything except .git, .planning, .claude from /tmp/pep-review-init to .
    ```

    After initialization, install Phase 1 dependencies:
    ```bash
    npm install zod
    npm install -D @wxt-dev/module-react vitest @types/react @types/react-dom
    ```

    Configure `wxt.config.ts` with these manifest overrides:
    - name: "PEP Review"
    - description: "AI-powered code review for Azure DevOps pull requests"
    - permissions: ["storage"]
    - host_permissions: ["https://dev.azure.com/*", "https://*.visualstudio.com/*"]
    - Add `modules: ['@wxt-dev/module-react']`

    Ensure TypeScript is configured with path aliases so `@/lib/*` and `@/shared/*` resolve correctly. WXT should handle this via its own tsconfig, but verify the paths work.

    Delete the default example content script and popup that WXT generates -- we will create our own in Plan 02 and 03.
  </action>
  <verify>
    Run `npm run build` from the project root. The build should succeed and produce output in `.output/chrome-mv3/`.
    Run `npm run check` or `npx tsc --noEmit` to verify TypeScript compiles cleanly.
  </verify>
  <done>
    WXT project builds successfully. package.json has wxt, react, zod, vitest. wxt.config.ts has correct manifest overrides with host_permissions for dev.azure.com. No default example entrypoints remain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared types, message definitions, storage helpers, URL matcher, and DOM selectors</name>
  <files>
    shared/types.ts
    shared/messages.ts
    shared/storage.ts
    shared/constants.ts
    lib/url-matcher.ts
    lib/selectors.ts
  </files>
  <action>
    Create `shared/types.ts`:
    - Export `PrInfo` interface with fields: `org: string`, `project: string`, `repo: string`, `prId: number`, `baseUrl: string` (format: `https://dev.azure.com/{org}/{project}`)
    - Export `AuthMethod` type: `'session' | 'pat' | 'none'`
    - Export `AuthStatus` interface: `{ authenticated: boolean; method: AuthMethod }`

    Create `shared/messages.ts`:
    - Define discriminated union `Message` type with these message types:
      - `CHECK_AUTH` with payload `{ orgUrl: string }` -- content script asks background to check auth
      - `AUTH_RESULT` with payload `{ authenticated: boolean; method: AuthMethod }` -- background responds with auth status
      - `SAVE_PAT` with payload `{ pat: string }` -- options page sends PAT to background for validation/storage
      - `PAT_RESULT` with payload `{ success: boolean; error?: string }` -- background responds with save result
    - Export `MessageType`, `MessagePayload<T>` helper types
    - Export `sendMessage<T>` function that wraps `chrome.runtime.sendMessage` with type safety

    Create `shared/storage.ts`:
    - Define storage keys as const object: `STORAGE_KEYS = { PAT: 'pat', AUTH_METHOD: 'auth_method' } as const`
    - Export typed getter: `getPat(): Promise<string | null>` -- reads from chrome.storage.local
    - Export typed setter: `setPat(pat: string): Promise<void>` -- writes to chrome.storage.local
    - Export `clearPat(): Promise<void>`

    Create `shared/constants.ts`:
    - Export `ADO_BASE = 'https://dev.azure.com'`
    - Export `ADO_API_VERSION = '7.1'`
    - Export `CONNECTION_DATA_PATH = '/_apis/connectionData'` (used for auth testing)
    - Export `PAT_LENGTH = 84` (Azure DevOps PAT expected length)

    Create `lib/url-matcher.ts`:
    - Import `PrInfo` from `@/shared/types`
    - Export `parsePrUrl(url: string): PrInfo | null` -- regex matches `dev.azure.com/{org}/{project}/_git/{repo}/pullrequest/{id}` and returns parsed components. Handle URL-encoded segments.
    - Export `isPullRequestUrl(url: string): boolean` -- thin wrapper around parsePrUrl
    - Export `buildApiUrl(prInfo: PrInfo, path: string): string` -- constructs API URLs like `https://dev.azure.com/{org}/{project}/_apis/{path}`
    - The regex: `/^https?:\/\/dev\.azure\.com\/([^/]+)\/([^/]+)\/_git\/([^/]+)\/pullrequest\/(\d+)/`

    Create `lib/selectors.ts`:
    - Export `SELECTORS` object with `PR_HEADER_ACTIONS` and `PR_TITLE` arrays (multiple fallback selectors each, as documented in research)
    - Export `querySelector(selectors: readonly string[]): Element | null` -- tries each selector in order, returns first match
    - Export `checkSelectorHealth(): void` -- logs warnings for selectors that match nothing
    - Export `waitForElement(selectors: readonly string[], timeoutMs: number): Promise<Element | null>` -- uses MutationObserver to wait for element to appear, with timeout. This is a standalone utility (no ctx dependency) for reuse.

    Follow the exact patterns from 01-RESEARCH.md code examples. Use JSDoc comments on all exported functions.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- all files compile cleanly with no type errors.
    Run `npm run build` -- build succeeds.
    Verify imports work: `lib/url-matcher.ts` imports from `@/shared/types`, `shared/messages.ts` imports from `@/shared/types`.
  </verify>
  <done>
    All 6 shared files exist and compile. `parsePrUrl` correctly extracts org/project/repo/prId from PR URLs. `isPullRequestUrl` returns true for PR URLs and false for non-PR URLs. `querySelector` tries multiple selectors in order. `sendMessage` provides type-safe message passing. Storage helpers wrap chrome.storage.local with typed accessors.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no errors
2. `npx tsc --noEmit` passes with no type errors
3. `.output/chrome-mv3/manifest.json` contains correct host_permissions for dev.azure.com
4. All shared modules import each other correctly (no circular dependencies)
</verification>

<success_criteria>
- WXT project initialized and builds cleanly
- Manifest includes host_permissions for dev.azure.com and *.visualstudio.com
- PrInfo type, URL matcher, selectors, messages, storage helpers, and constants all exist and compile
- No example/placeholder entrypoints remain from WXT template
</success_criteria>

<output>
After completion, create `.planning/phases/01-extension-shell-auth/01-01-SUMMARY.md`
</output>
